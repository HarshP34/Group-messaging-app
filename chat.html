<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat page</title>
</head>
<body >
    
    <div id="chat-container">
        <p style="font-size:40px;margin-left:42%;font-weight: bold;">Chat App</p>
        <ul id="chats"></ul>
    <form id="chat-form" style="margin-top: 50px;margin-left: 500px;">
        <input type="text" id="message" name="message" style="width:500px;">
        <button id="send-message">Send</button>
    </form>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.1.2/axios.min.js"></script>
<script>
   const MyForm=document.getElementById('chat-form');
   const message=document.getElementById('message');
   const SendBtn=document.getElementById('send-message');
const token=localStorage.getItem('token');
const user=localStorage.getItem('user');
   SendBtn.addEventListener('click',sendMessage);
   const ul=document.getElementById('chats');

   async function sendMessage(e)
   {
    e.preventDefault();
    if(message.value==='')
    alert('Please write something');
    else{
        const chatDetails={
            message:message.value
        }
        const res=await axios.post('http://localhost:3000/admin/user/chat',chatDetails,{headers:{'Authentication':token}});
        ul.innerHTML='';
        reload();
        message.value='';
    }
   }
  
setInterval(async()=>{
    
   const chats= await axios.get(`http://localhost:3000/admin/user/newmessages?lastmessageid=${localStorage.getItem('lastmessageid')||0}`,{headers:{'Authentication':token}});
   console.log(chats.data);
   const newmessages=chats.data.chats;
if(newmessages.length!=0)
localStorage.setItem('lastmessageid',newmessages[newmessages.length-1].id);
   for(let i=0;i<newmessages.length;i++)
   {
        const users=JSON.parse(localStorage.getItem('messages'));
    for(j=0;j<users.length;j++)
    {
        if(newmessages[i].userId===users[j].id)
        {
             if(users[j].name===localStorage.getItem('user'))
             {
     let li=document.createElement('li');
    li.className='userchat';
    li.appendChild(document.createTextNode(`You:${newmessages[i].message}`));
    ul.appendChild(li);
             }
             else{
                let li=document.createElement('li');
    li.className='userchat';
    li.appendChild(document.createTextNode(`${users[j].name}:${newmessages[i].message}`));
    ul.appendChild(li);
             }
        }
    }
    
   

   }
},10000)


   document.addEventListener('DOMContentLoaded',reload);
   async function reload()
   {
    try{
    const res=await axios.get(`http://localhost:3000/admin/user/chat`,{headers:{'Authentication':token}});
   //console.log(res.data); 
   
localStorage.setItem('messages',JSON.stringify(res.data.users));

let lastmessageid=0;
   for(let i=0;i<res.data.users.length;i++)
   {
     if(res.data.users[i].name===localStorage.getItem('user'))
     {
        res.data.users[i].chats.forEach((chat)=>{
            if(chat.id>lastmessageid)
            lastmessageid=chat.id;
    let li=document.createElement('li');
    li.className='userchat';
    li.appendChild(document.createTextNode(`You:${chat.message}`));
    ul.appendChild(li);
     })
    }
    else
    {
    res.data.users[i].chats.forEach((chat)=>{
        if(chat.id>lastmessageid)
            lastmessageid=chat.id;
    let li=document.createElement('li');
    li.className='userchat';
    li.appendChild(document.createTextNode(`${res.data.users[i].name}:${chat.message}`));
    ul.appendChild(li);
    }) 
    }
    localStorage.setItem('lastmessageid',lastmessageid);
   }
    }catch(err){console.log(err)}
   }
</script>
</body>
</html>